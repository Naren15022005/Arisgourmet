name: CI

on:
  push:
    branches: [ main, hardening/backend-devops ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: arisgourmet
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -prootpassword --silent"
          --health-interval=10s --health-timeout=5s --health-retries=10
      redis:
        image: redis:7

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Wait for MySQL
        run: |
          set -euo pipefail
          if ! command -v mysqladmin >/dev/null 2>&1; then
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y default-mysql-client
          fi
          count=0
          until mysqladmin ping -h mysql -uroot -prootpassword --silent; do
            count=$((count+1))
            echo "MySQL not reachable yet (attempt: $count)"
            if [ "$count" -ge 180 ]; then
              echo "Timed out waiting for MySQL"
              echo "=== Debug: resolve host mysql ==="
              getent hosts mysql || true
              echo "=== Debug: docker ps -a ==="
              docker ps -a || true
              echo "=== Debug: docker networks ==="
              docker network ls || true
              echo "=== Debug: mysql container inspect/logs ==="
              MYSQL_ID=$(docker ps -a --filter "name=mysql" --format "{{.ID}}" | head -n 1)
              if [ -n "${MYSQL_ID:-}" ]; then
                docker inspect "$MYSQL_ID" || true
                docker logs "$MYSQL_ID" || true
              else
                echo "No docker container matched name=mysql"
              fi
              exit 1
            fi
            sleep 2
          done

      - name: Create DB and CI user
        run: |
          set -euo pipefail
          mysql -h mysql -uroot -prootpassword -e "CREATE DATABASE IF NOT EXISTS arisgourmet; CREATE USER IF NOT EXISTS 'ci'@'%' IDENTIFIED BY 'ci_pass'; GRANT ALL PRIVILEGES ON arisgourmet.* TO 'ci'@'%'; FLUSH PRIVILEGES;"

      - name: Install dependencies
        run: |
          cd backend
          npm ci
      - name: Run migrations
        env:
          DB_HOST: mysql
          DB_PORT: 3306
          DB_NAME: arisgourmet
          DB_USER: ci
          DB_PASS: ci_pass
          DATABASE_URL: mysql://ci:ci_pass@mysql:3306/arisgourmet
        run: |
          cd backend
          npm run migrate:run
      - name: Run tests
        env:
          DB_HOST: mysql
          DB_PORT: 3306
          DB_NAME: arisgourmet
          DB_USER: ci
          DB_PASS: ci_pass
          DATABASE_URL: mysql://ci:ci_pass@mysql:3306/arisgourmet
          REDIS_URL: redis://redis:6379
        run: |
          cd backend
          npm test --silent
