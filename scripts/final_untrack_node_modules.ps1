Write-Host 'Final untrack: create backup, remove remaining node_modules from index'

git fetch origin

git checkout main

git pull origin main

$bk = 'backup-before-final-untrack-' + (Get-Date -Format 'yyyyMMddHHmmss')
Write-Host "Creating backup branch: $bk"
git branch $bk
git push -u origin $bk

$tracked = git ls-files | Select-String 'node_modules' | ForEach-Object { $_.ToString().Trim() }
if ($tracked) {
  $count = ($tracked | Measure-Object).Count
  Write-Host "Remaining tracked node_modules entries before: $count"
  foreach ($f in $tracked) {
    git rm --cached -- "$f"
  }
} else {
  Write-Host 'No tracked node_modules found'
}

cmd /c 'git diff --staged --quiet'
if ($LASTEXITCODE -ne 0) {
  git commit -m 'chore: untrack remaining node_modules (final)'
  git push origin main
  Write-Host 'Committed and pushed changes to origin/main'
} else {
  Write-Host 'No staged changes to commit'
}

Write-Host 'Done'
