Write-Host 'Loop untrack: remove tracked node_modules in batches (max 10 iterations)'

git fetch origin

git checkout main

git pull origin main

$max = 10
for ($i = 1; $i -le $max; $i++) {
  Write-Host "Iteration $i"
  $tracked = git ls-files | Select-String 'node_modules' | ForEach-Object { $_.ToString().Trim() }
  $count = 0
  if ($tracked) { $count = ($tracked | Measure-Object).Count }
  Write-Host "Remaining tracked node_modules before iteration: $count"
  if ($count -eq 0) { Write-Host 'No tracked node_modules left; exiting loop'; break }

  foreach ($f in $tracked) {
    git rm --cached -- "$f" 2>$null
  }

  cmd /c 'git diff --staged --quiet'
  if ($LASTEXITCODE -ne 0) {
    git commit -m "chore: untrack node_modules (batch iteration $i)"
    Write-Host "Committed batch $i"
    git push origin main
    Write-Host "Pushed batch $i"
  } else {
    Write-Host 'No staged changes to commit in this iteration'
  }

  Start-Sleep -Seconds 1
}

# Final count
$final = (git ls-files | Select-String 'node_modules' | Measure-Object).Count
Write-Host "Final tracked node_modules count: $final"
