Write-Host 'Starting untrack node_modules (safe, cached only)'

git fetch origin

git checkout main

git pull origin main

$bk = 'backup-before-untrack-nodemodules-' + (Get-Date -Format 'yyyyMMddHHmmss')
Write-Host "Creating backup branch: $bk"
git branch $bk
git push -u origin $bk

$patterns = @('**/node_modules','node_modules/','snapshot-full.tar','snapshot_extract/')
if (-not (Test-Path .gitignore)) { New-Item -Path .gitignore -ItemType File -Force }
foreach ($p in $patterns) {
  if (-not (Select-String -SimpleMatch -Quiet $p .gitignore 2>$null)) {
    Add-Content -Path .gitignore -Value $p
    Write-Host "Added to .gitignore: $p"
  } else {
    Write-Host "Already in .gitignore: $p"
  }
}

git add .gitignore

Write-Host 'Finding tracked node_modules files...'
$tracked = git ls-files | Select-String 'node_modules' | ForEach-Object { $_.ToString().Trim() }
if ($tracked) {
  $count = ($tracked | Measure-Object).Count
  Write-Host "Tracked node_modules entries: $count"
  foreach ($f in $tracked) {
    git rm --cached -- "$f"
  }
  Write-Host 'Untracked node_modules files (cached)'
} else {
  Write-Host 'No tracked node_modules files found'
}

cmd /c 'git diff --staged --quiet'
if ($LASTEXITCODE -ne 0) {
  git commit -m "chore: stop tracking node_modules; update .gitignore"
  Write-Host 'Committed change'
  git push origin main
  Write-Host 'Pushed to origin/main'
} else {
  Write-Host 'No staged changes to commit'
}

Write-Host 'Done'
